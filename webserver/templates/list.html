{% extends "base.html" %}
{% block content %}

    <div class="main-wrapper happy-margin">

        <section class="main-table-wrapper" toolversion>
            <div class="table-nav flex top-tail-margin top-tail-padding">
                <div class="table-nav-left">
                    <span class="usb-icon inline-block">
                        <img alt="USB icon" src="/scute/images/usb-icon.png">
                    </span>
                    <div class="inline-block navy table-header">
                        <h2>Device Manager</h2>
                        
                    </div>
                    <button><a href="/list">Reload</a></button>
                </div>
                <div class="table-nav-right gray">
                    <div class="last-loaded key inline-block">
                        <p class="inline-block light-gray">Last loaded:</p>
                    </div>
                    <div class="date value inline-block">
                        <p class="inline-block">{{ timeLoaded }}</p>
                    </div>
                </div>
            </div>

            {% if reportValues | length > 0 %}

            {% if 'error' in reportValues %}

                <section class="main-table">
                    <div class="happy-margin no-devices">
                        <div class="alert error">
                            <img src="/static/images/invalid_firmware_white.png" width="100px"/>
                            <h1>{{reportValues.error}}</h1>
                            {{reportValues.message}}
                        </div>
                    </div>
                </section>

            {%else%}

            <section class="main-table">
                <table>
                    <tr>
                        <td></td>
                        {% for device in reportValues %}
                            <td data-device="{{device}}" class="deviceHeader">
                                <span class="circle selected-no"></span>
                                {{reportValues[device].friendlyName}}
                            </td>
                        {% endfor %}
                    </tr>
                    <!-- categories in report loop -->
                    {% for key,category in reportSchema.items() | sort(attribute='1.order') %}

                        <!-- report field loop rows -->
                        {% for fieldKey,fieldSchema in category.fields.items() | sort(attribute='1.order') %}
                            <tr>

                                <td>{{fieldSchema.label}}</td>

                                <!-- output the field cell -->
                                {% for deviceKey,deviceValues in reportValues.items() %}
                                    <td data-device="{{deviceKey}}">

                                        {% if deviceValues[fieldKey] is iterable and deviceValues[fieldKey] is not string %}

                                            {# Check if list #}

                                            {% for value in deviceValues[fieldKey] %}

                                                {{value}}<br>

                                            {% endfor %}

                                        {% else %}
                                             {{deviceValues[fieldKey] | safe}}
                                        {% endif %}

                                    </td>
                                {% endfor %}
                            </tr>

                        {% endfor %}

                    {% endfor %}

                </table>

            </section>
            {%endif%}
            {% else %}

            <section class="main-table">
                <div class="happy-margin no-devices">
                    <div class="alert info">
                        <img src="/static/images/usb-connect-white.png" width="100px"/>
                        <h1>No configured devices detected.</h1>Please connect a device and <a href="/list">reload the page.</a>
                    </div>
                </div>
            </section>
            {% endif %}

            <div class="divider"></div>

            <section class="buttons actions">

                <div class="buttons-wrapper">
                    <select data-action="applyPreset" onchange="triggerAction(event)" data-bulk="true" disabled>
                        <option value=''>Apply Preset</option>

                        {% for option in presetValues%}
                            <option value="{{option.value}}">{{option.label}}</option>
                        {% endfor %}                

                    </select>

                    <button onclick="triggerAction(event)" data-action="config" data-bulk="false" disabled>Device Config</button>

                    {% for key,action in actions.items() %}

                        {# Check if list or select #}

                        {% if action.list %}

                            <select onchange="triggerAction(event)" {% if action.warn %} data-warn="true" {% endif %} {% if action.bulk %} data-bulk="true" {% else %} data-bulk="false" {% endif %} class="{% if action.warn %} scary {% endif %}" data-action="{{key}}" disabled>

                                <option value="">{{action.label}}</option>

                                {% for key,value in action.list.items() %}

                                    <option value="{{value}}">{{key}}</option>

                                {% endfor %}

                            </select>

                        {% else %}

                            <button onclick="triggerAction(event)" {% if action.warn %} data-warn="true" {% endif %} {% if action.bulk %} data-bulk="true" {% else %} data-bulk="false" {% endif %} class="{% if action.warn %} scary {% endif %}" data-action="{{key}}" disabled>{{action.label}}</button>

                        {% endif %}


                    {% endfor %}

                    <br/>

                </div>

            </section>

        </section>

    </div>
{% endblock %}
